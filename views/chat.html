<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vignette Discussion</title>
    <link rel="stylesheet" href="styles.css?v=1.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .vignette-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .vignette-display h3 {
            margin-top: 0;
            color: #007bff;
        }
        
        .vignette-display p {
            line-height: 1.6;
            margin: 0;
            font-size: 14px;
            text-align: justify;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.ai {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
        }
        
        .message-input {
            display: flex;
            gap: 10px;
        }
        
        .message-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .message-input button {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .message-input button:hover {
            background: #0056b3;
        }
        
        .message-input button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.3s;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        .welcome-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-container">
            <a href="/" class="back-button">
                <i class="fas fa-arrow-left"></i> Back to Form
            </a>
            
            <h1>AI Vignette Discussion</h1>
            
            <div class="vignette-display">
                <h3>Your Vignette:</h3>
                <p id="vignette-text">No vignette available. Please go back and generate a vignette first.</p>
            </div>
            
            <div class="welcome-message">
                <strong>Welcome to the AI Discussion!</strong><br>
                You can now chat with an AI assistant about your vignette. Ask questions, explore different perspectives, or discuss any aspects of the scenario. The AI will help you think critically about the content.
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message ai">
                    <strong>AI Assistant:</strong> Hello! I'm here to help you discuss and analyze your vignette. What would you like to explore about this scenario? You could ask about the student's situation, the support strategies, potential outcomes, or anything else that interests you.
                </div>
            </div>
            
            <div class="loading" id="loading">
                <i class="fas fa-spinner fa-spin"></i> AI is thinking...
            </div>
            
            <div class="message-input">
                <input type="text" id="user-input" placeholder="Type your message here..." maxlength="500">
                <button id="send-button">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const vignetteText = document.getElementById('vignette-text');
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const loading = document.getElementById('loading');
            
            // Get user ID from localStorage (same as main form)
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            
            // Track message count for bias analysis feature
            let messageCount = 0;
            let biasAnalysisShown = false;
            
            // Get vignette from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const vignette = urlParams.get('vignette') || localStorage.getItem('currentVignette');
            
            if (vignette) {
                // Clean and format the vignette for better display
                const cleanVignette = decodeURIComponent(vignette);
                vignetteText.textContent = cleanVignette;
                localStorage.setItem('currentVignette', cleanVignette);
            }
            
            // Log page load
            fetch('/api/log-interaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    interaction_type: 'page_load',
                    page: 'chat',
                    action: 'chat_opened',
                    details: 'User opened chat page',
                    session_data: JSON.stringify({ has_vignette: !!vignette })
                })
            }).catch(console.error);
            
            const sendMessage = async () => {
                const message = userInput.value.trim();
                if (!message || !vignette) return;
                
                // Add user message to chat
                const userMessage = document.createElement('div');
                userMessage.className = 'message user';
                userMessage.innerHTML = `<strong>You:</strong> ${message}`;
                chatMessages.appendChild(userMessage);
                
                // Clear input and disable button
                userInput.value = '';
                sendButton.disabled = true;
                loading.style.display = 'block';
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            vignette: vignette,
                            message: message,
                            user_id: userId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // Add AI response to chat
                        const aiMessage = document.createElement('div');
                        aiMessage.className = 'message ai';
                        aiMessage.innerHTML = `<strong>AI Assistant:</strong> ${data.response}`;
                        chatMessages.appendChild(aiMessage);
                        
                        // Increment message count and check for bias analysis feature
                        messageCount++;
                        if (messageCount >= 5 && !biasAnalysisShown) {
                            showBiasAnalysisOption();
                            biasAnalysisShown = true;
                        }
                    } else {
                        throw new Error(data.error || 'Failed to get AI response');
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'message ai';
                    errorMessage.innerHTML = `<strong>AI Assistant:</strong> I'm sorry, I encountered an error. Please try again. (${error.message})`;
                    chatMessages.appendChild(errorMessage);
                } finally {
                    loading.style.display = 'none';
                    sendButton.disabled = false;
                    userInput.focus();
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            };
            
            sendButton.addEventListener('click', sendMessage);
            
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Function to show bias analysis option after 10 interactions
            const showBiasAnalysisOption = () => {
                const biasMessage = document.createElement('div');
                biasMessage.className = 'message ai';
                biasMessage.style.background = '#fff3cd';
                biasMessage.style.border = '1px solid #ffeaa7';
                biasMessage.innerHTML = `
                    <strong>üéâ Excellent!</strong> You've had 5+ meaningful interactions about your vignette. 
                    You've now unlocked the <strong>Bias Analysis</strong> feature! 
                    <br><br>
                    <strong>üéØ New Challenge:</strong> Now let's focus on <em>critical analysis</em>. After you get your bias analysis, 
                    I want you to <strong>question it, challenge it, and think critically</strong> about the findings. 
                    Are there biases the AI missed? Do you disagree with any conclusions?
                    <br><br>
                    <button id="bias-analysis-btn" style="background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                        üîç Analyze My Vignette for Bias
                    </button>
                `;
                chatMessages.appendChild(biasMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Add event listener to bias analysis button
                document.getElementById('bias-analysis-btn').addEventListener('click', performBiasAnalysis);
            };
            
            // Function to perform bias analysis
            const performBiasAnalysis = async () => {
                const biasBtn = document.getElementById('bias-analysis-btn');
                biasBtn.disabled = true;
                biasBtn.textContent = 'üîç Analyzing...';
                
                try {
                    const response = await fetch('/api/student-bias', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            vignette: vignette,
                            user_id: userId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // Add bias analysis result to chat
                        const biasResult = document.createElement('div');
                        biasResult.className = 'message ai';
                        biasResult.style.background = '#f8d7da';
                        biasResult.style.border = '1px solid #f5c6cb';
                        biasResult.innerHTML = `
                            <strong>üîç Bias Analysis Results:</strong><br><br>
                            ${data.bias_analysis.replace(/\n/g, '<br>')}
                        `;
                        chatMessages.appendChild(biasResult);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        // Hide the bias analysis button
                        biasBtn.style.display = 'none';
                        
                        // Add critical thinking prompt after bias analysis
                        setTimeout(() => {
                            const criticalPrompt = document.createElement('div');
                            criticalPrompt.className = 'message ai';
                            criticalPrompt.style.background = '#d1ecf1';
                            criticalPrompt.style.border = '1px solid #bee5eb';
                            criticalPrompt.innerHTML = `
                                <strong>ü§î Now for the Critical Part!</strong><br><br>
                                I've provided my bias analysis above, but <strong>I want you to challenge it</strong>. Think critically:
                                <br><br>
                                ‚Ä¢ <strong>Do you agree</strong> with all the biases I identified?<br>
                                ‚Ä¢ <strong>Did I miss any biases</strong> that you can see?<br>
                                ‚Ä¢ <strong>Are there alternative interpretations</strong> of the scenario?<br>
                                ‚Ä¢ <strong>What would you change</strong> about the vignette to reduce bias?<br>
                                ‚Ä¢ <strong>How might different people</strong> interpret this scenario differently?<br>
                                <br>
                                <em>Don't just accept my analysis - question it, debate it, and share your own critical thoughts!</em>
                            `;
                            chatMessages.appendChild(criticalPrompt);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, 2000); // Show after 2 seconds
                        
                    } else {
                        throw new Error(data.error || 'Failed to get bias analysis');
                    }
                } catch (error) {
                    console.error('Bias analysis error:', error);
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'message ai';
                    errorMessage.style.background = '#f8d7da';
                    errorMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
                    chatMessages.appendChild(errorMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Re-enable button
                    biasBtn.disabled = false;
                    biasBtn.textContent = 'üîç Analyze My Vignette for Bias';
                }
            };
            
            // Focus on input
            userInput.focus();
        });
    </script>
</body>
</html>
