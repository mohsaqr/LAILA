<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bias Research Platform</title>
    <link rel="stylesheet" href="styles.css?v=1.1">
    <link rel="stylesheet" href="unified-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="navigation.js"></script>
    <style>
        .platform-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        
        .platform-header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .platform-title {
            color: white;
            font-size: 2.5em;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .platform-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1.2em;
            margin: 0;
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .mode-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 15px 30px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: bold;
        }
        
        .mode-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .mode-button.active {
            background: white;
            color: #667eea;
            border-color: white;
        }
        
        .content-panel {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }
        
        .content-panel.active {
            display: block;
        }
        
        .option-button {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .option-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .option-button.secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .option-button.secondary:hover {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        .option-button.tertiary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .option-button.tertiary:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }
        
        .option-description {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 8px;
        }
        
        .comparison-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 5px solid #007bff;
        }
        
        .story-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .story-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .story-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .story-content {
            line-height: 1.6;
            color: #333;
            font-size: 14px;
        }
        
        .comparison-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .comparison-type {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .comparison-type.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .discussion-prompt {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #007bff;
        }
        
        .discussion-prompt h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .discussion-questions {
            list-style: none;
            padding: 0;
        }
        
        .discussion-questions li {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #28a745;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin: 20px 0;
        }
        
        /* Chat Interface Styles */
        .chat-interface {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 30px;
        }
        
        .chat-interface.active {
            display: block;
        }
        
        .chat-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        
        .message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            max-width: 85%;
            line-height: 1.6;
        }
        
        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.ai {
            background: white;
            border: 1px solid #ddd;
            color: #333;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .typing-indicator {
            display: none;
            padding: 15px;
            color: #667eea;
            font-style: italic;
        }
        
        .story-form-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .story-input {
            display: inline-block;
            background: #fff;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 8px 15px;
            margin: 5px;
            font-weight: bold;
            color: #2980b9;
            min-width: 120px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .story-input:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .story-input select, .story-input input, .story-input textarea {
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: bold;
            color: inherit;
            width: 100%;
            text-align: center;
            outline: none;
        }
        
        @media (max-width: 768px) {
            .story-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="platform-container">
        <!-- Header -->
        <div class="platform-header">
            <h1 class="platform-title">🎯 Bias Research Platform</h1>
            <p class="platform-subtitle">Academic vignette creation, analysis, and bias detection</p>
        </div>
        
        <!-- Main Functions -->
        <div class="content-panel active">
            <button class="option-button" onclick="window.location.href='story-form'">
                <i class="fas fa-edit"></i> Interactive Story Builder
                <div class="option-description">Create a detailed vignette through guided storytelling</div>
            </button>
            
            <button class="option-button secondary" onclick="showQuickStoryForm()">
                <i class="fas fa-bolt"></i> Quick Story Generator
                <div class="option-description">Generate a story with minimal inputs</div>
            </button>
            
            <button class="option-button tertiary" onclick="showComparisonOptions()">
                <i class="fas fa-balance-scale"></i> Generate Comparison Stories
                <div class="option-description">Create contrasting vignettes for bias analysis</div>
            </button>
            
            
            <!-- Quick Story Form -->
            <div id="quick-story-form" class="story-form-section" style="display: none;">
                <h3 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">Quick Story Generator</h3>
                <div style="text-align: center; line-height: 2;">
                    A student from 
                    <span class="story-input">
                        <select id="quick-nationality">
                            <option value="">country</option>
                            <option value="United States">United States</option>
                            <option value="Germany">Germany</option>
                            <option value="China">China</option>
                            <option value="India">India</option>
                            <option value="Brazil">Brazil</option>
                            <option value="Nigeria">Nigeria</option>
                        </select>
                    </span>
                    who uses 
                    <span class="story-input">
                        <select id="quick-pronoun">
                            <option value="">pronoun</option>
                            <option value="his">his</option>
                            <option value="her">her</option>
                            <option value="their">their</option>
                        </select>
                    </span>
                    pronouns is studying 
                    <span class="story-input">
                        <select id="quick-field">
                            <option value="">field</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Psychology">Psychology</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Business">Business</option>
                        </select>
                    </span>
                    and is progressing 
                    <span class="story-input">
                        <select id="quick-progress">
                            <option value="">how?</option>
                            <option value="very well">very well</option>
                            <option value="poorly">poorly</option>
                            <option value="adequately">adequately</option>
                        </select>
                    </span>
                    in their studies.
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="option-button" onclick="generateQuickStory()" style="width: auto; display: inline-block; margin: 10px;">
                        <i class="fas fa-magic"></i> Generate Story
                    </button>
                </div>
                
                <div id="quick-story-result" style="display: none; margin-top: 20px; padding: 20px; background: white; border-radius: 10px; border-left: 5px solid #28a745;">
                    <h4 style="color: #2c3e50;">Generated Story:</h4>
                    <div id="quick-story-text" style="line-height: 1.6; color: #333;"></div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="option-button secondary" onclick="continueToChat()" style="width: auto; display: inline-block; margin: 10px;">
                            <i class="fas fa-comments"></i> Continue to Chat
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Compare Stories Panel -->
        <div id="compare-panel" class="content-panel">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">⚖️ Generate Comparison Stories</h2>
            
            <div class="comparison-controls">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">Choose Comparison Type:</h3>
                <div class="comparison-type active" onclick="selectComparisonType('gender')" data-type="gender">
                    <i class="fas fa-venus-mars"></i> Gender Comparison
                </div>
                <div class="comparison-type" onclick="selectComparisonType('geography')" data-type="geography">
                    <i class="fas fa-globe"></i> Global South vs North
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="option-button" onclick="generateComparisonStories()" style="width: auto; display: inline-block;">
                    <i class="fas fa-balance-scale"></i> Generate Comparison Stories
                </button>
            </div>
            
            <div class="loading" id="comparison-loading">
                <i class="fas fa-spinner fa-spin"></i> Generating comparison stories...
            </div>
            
            <div class="comparison-section" id="comparison-stories">
                <h3 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-balance-scale"></i> Story Comparison Analysis
                </h3>
                
                <div class="story-container">
                    <div class="story-box">
                        <div class="story-title" id="story-a-title">Story A</div>
                        <div class="story-content" id="story-a-content"></div>
                    </div>
                    
                    <div class="story-box">
                        <div class="story-title" id="story-b-title">Story B</div>
                        <div class="story-content" id="story-b-content"></div>
                    </div>
                </div>
                
                <div class="discussion-prompt">
                    <h4><i class="fas fa-comments"></i> Discussion Questions</h4>
                    <ul class="discussion-questions" id="discussion-questions">
                        <!-- Questions will be populated based on comparison type -->
                    </ul>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="option-button" onclick="generateComparisonStories()" style="width: auto; display: inline-block; margin: 10px;">
                        <i class="fas fa-sync-alt"></i> Generate New Pair
                    </button>
                    <button class="option-button secondary" onclick="continueToChat()" style="width: auto; display: inline-block; margin: 10px;">
                        <i class="fas fa-comments"></i> Continue to Chat
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Traditional Form Panel -->
        <div id="traditional-panel" class="content-panel">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">📋 Traditional Data Collection</h2>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <p style="color: #7f8c8d; font-size: 1.1em; line-height: 1.6;">
                    Use the traditional multi-step form for comprehensive data collection and analysis.
                </p>
            </div>
            
            <button class="option-button" onclick="window.location.href='/'">
                <i class="fas fa-clipboard-list"></i> Open Traditional Form
                <div class="option-description">Multi-step data collection with validation</div>
            </button>
            
            <button class="option-button secondary" onclick="window.location.href='admin'">
                <i class="fas fa-download"></i> Admin Panel
                <div class="option-description">Download data and perform bias analysis</div>
            </button>
        </div>
        
        <!-- Chat Interface for Bias Analysis -->
        <div id="chat-interface" class="chat-interface">
            <div class="chat-header">
                <h2><i class="fas fa-robot"></i> Bias Analysis Assistant</h2>
                <p>Discuss and analyze your vignette with our AI assistant</p>
            </div>
            
            <div id="chat-messages" class="chat-messages">
                <div class="message ai">
                    <strong>🔍 Bias Analysis Assistant:</strong><br><br>
                    I'm here to help you analyze potential biases in your vignette. I'll examine various forms of bias including gender, cultural, socioeconomic, confirmation, and selection bias, and provide constructive feedback to promote awareness and better practices.
                    <br><br>
                    Let's start by discussing your vignette. What aspects would you like me to focus on?
                </div>
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                <i class="fas fa-ellipsis-h"></i> Assistant is typing...
            </div>
            
            <div class="chat-input-container">
                <input type="text" id="chat-input" class="chat-input" placeholder="Type your message or ask about bias analysis..." maxlength="500">
                <button id="send-btn" class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="option-button tertiary" onclick="returnToStories()" style="width: auto; display: inline-block;">
                    <i class="fas fa-arrow-left"></i> Back to Stories
                </button>
            </div>
        </div>
    </div>

    <script>
        // User session management
        let userId = localStorage.getItem('userId');
        if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userId', userId);
        }

        let selectedComparisonType = 'gender';

        // Log page load
        fetch('/api/log-interaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: userId,
                interaction_type: 'page_load',
                page: 'bias_research_platform',
                action: 'platform_opened',
                details: 'User opened integrated bias research platform',
                session_data: ''
            })
        }).catch(console.error);

        function showQuickStoryForm() {
            const form = document.getElementById('quick-story-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            if (form.style.display === 'block') {
                form.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function showComparisonOptions() {
            const panel = document.getElementById('compare-panel');
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        function generateQuickStory() {
            const nationality = document.getElementById('quick-nationality').value;
            const pronoun = document.getElementById('quick-pronoun').value;
            const field = document.getElementById('quick-field').value;
            const progress = document.getElementById('quick-progress').value;

            if (!nationality || !pronoun || !field || !progress) {
                alert('Please fill in all fields to generate a story.');
                return;
            }

            const story = `This ${nationality} student is studying ${field} and is progressing ${progress} in ${pronoun} academic goals. The student demonstrates consistent engagement with coursework and actively participates in class discussions. Based on learning analytics data, the student shows regular login patterns and completes assignments on time. The mentor recommended 3 hours of support per week delivered by the teacher. After receiving support, the student scored 85 out of 100 and completed the program successfully.`;

            document.getElementById('quick-story-text').textContent = story;
            document.getElementById('quick-story-result').style.display = 'block';
            document.getElementById('quick-story-result').scrollIntoView({ behavior: 'smooth' });

            // Log story generation
            fetch('/api/log-interaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    interaction_type: 'story_generation',
                    page: 'bias_research_platform',
                    action: 'generate_quick_story',
                    details: 'User generated quick story',
                    session_data: JSON.stringify({ nationality, pronoun, field, progress })
                })
            }).catch(console.error);
        }

        function selectComparisonType(type) {
            selectedComparisonType = type;
            document.querySelectorAll('.comparison-type').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
        }

        async function generateComparisonStories() {
            const loading = document.getElementById('comparison-loading');
            const comparisonSection = document.getElementById('comparison-stories');
            
            loading.style.display = 'block';
            comparisonSection.style.display = 'none';

            // Log the action
            fetch('/api/log-interaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    interaction_type: 'comparison_generation',
                    page: 'bias_research_platform',
                    action: 'generate_comparison_stories',
                    details: `User requested ${selectedComparisonType} comparison`,
                    session_data: selectedComparisonType
                })
            }).catch(console.error);

            // Simulate generation delay
            await new Promise(resolve => setTimeout(resolve, 2000));

            let storyA, storyB, titleA, titleB, questions;

            if (selectedComparisonType === 'gender') {
                titleA = "Male Student - Engineering";
                titleB = "Female Student - Engineering";
                storyA = "Alex, a dedicated male student from Germany, is studying Engineering and is progressing very well in his academic goals. He demonstrates strong analytical skills and actively participates in technical discussions. Based on learning analytics, Alex shows consistent engagement with programming assignments and laboratory work. His mentor recommended 2 hours of support per week delivered by a senior peer. After receiving support, Alex scored 92 out of 100 and completed the program successfully.";
                storyB = "Alexandra, a dedicated female student from Germany, is studying Engineering and is progressing very well in her academic goals. She demonstrates strong analytical skills and actively participates in technical discussions. Based on learning analytics, Alexandra shows consistent engagement with programming assignments and laboratory work. Her mentor recommended 4 hours of support per week delivered by the teacher. After receiving support, Alexandra scored 88 out of 100 and completed the program successfully.";
                
                questions = [
                    "<strong>Gender Bias Detection:</strong> Are there differences in how support is provided based on gender?",
                    "<strong>Performance Expectations:</strong> Do the stories suggest different expectations for male vs female students?",
                    "<strong>Support Mechanisms:</strong> Why might different types of support be recommended?",
                    "<strong>Language Analysis:</strong> Are there subtle differences in how achievements are described?",
                    "<strong>Implicit Assumptions:</strong> What assumptions about gender roles might influence these scenarios?"
                ];
            } else {
                titleA = "Global North Student - Medicine";
                titleB = "Global South Student - Medicine";
                storyA = "Emma, a dedicated student from Germany, is studying Medicine and is progressing very well in her academic goals. She has access to state-of-the-art facilities and advanced medical equipment. Based on learning analytics, Emma shows consistent engagement with online resources and virtual patient simulations. Her mentor recommended 2 hours of support per week delivered by the teacher. After receiving support, Emma scored 94 out of 100 and completed the program successfully.";
                storyB = "Amara, a dedicated student from Nigeria, is studying Medicine and is progressing very well in her academic goals. She demonstrates exceptional resourcefulness despite limited access to advanced facilities. Based on learning analytics, Amara shows consistent engagement with available resources and peer study groups. Her mentor recommended 5 hours of support per week delivered by the teacher. After receiving support, Amara scored 89 out of 100 and completed the program successfully.";
                
                questions = [
                    "<strong>Resource Disparity:</strong> How do different resource levels affect the narrative?",
                    "<strong>Support Requirements:</strong> Why might students from different regions need different support levels?",
                    "<strong>Achievement Context:</strong> How is success framed differently based on geographic origin?",
                    "<strong>Implicit Bias:</strong> What assumptions about Global South vs North capabilities are present?",
                    "<strong>Equity Considerations:</strong> How might these differences impact educational equity?"
                ];
            }

            // Display the stories
            document.getElementById('story-a-title').textContent = titleA;
            document.getElementById('story-a-content').textContent = storyA;
            document.getElementById('story-b-title').textContent = titleB;
            document.getElementById('story-b-content').textContent = storyB;

            // Display questions
            const questionsList = document.getElementById('discussion-questions');
            questionsList.innerHTML = questions.map(q => `<li>${q}</li>`).join('');

            loading.style.display = 'none';
            comparisonSection.style.display = 'block';
            comparisonSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Sample vignettes for random generation
        const sampleVignettes = [
            {
                title: "Academic Performance Scenario",
                content: "Sarah, a dedicated student from a middle-class family, consistently achieves high grades through her diligent study habits and natural aptitude for learning. She actively participates in class discussions and seeks help when needed."
            },
            {
                title: "Academic Performance Scenario",
                content: "Sarah, a student who comes from a privileged background, manages to get good grades despite her tendency to rely on expensive tutoring and test preparation services that her family can afford."
            },
            {
                title: "Research Participation",
                content: "Dr. Martinez brings valuable expertise to the research team through years of rigorous academic training and demonstrates commitment by working long hours to ensure project deadlines are met."
            },
            {
                title: "Research Participation",
                content: "Dr. Martinez, despite having an impressive academic pedigree, sometimes struggles to meet project deadlines and occasionally needs reminders about important research protocols and procedures."
            }
        ];

        async function generateRandomVignettes() {
            const loading = document.getElementById('comparison-loading');
            const comparisonSection = document.getElementById('comparison-stories');
            
            loading.style.display = 'block';
            comparisonSection.style.display = 'none';

            // Log the action
            fetch('/api/log-interaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    interaction_type: 'random_vignette_generation',
                    page: 'bias_research_platform',
                    action: 'generate_random_vignettes',
                    details: 'User requested random vignette comparison',
                    session_data: 'random_comparison'
                })
            }).catch(console.error);

            // Simulate generation delay
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Select two different random vignettes
            const shuffled = [...sampleVignettes].sort(() => 0.5 - Math.random());
            const selectedA = shuffled[0];
            const selectedB = shuffled[1];

            document.getElementById('story-a-title').textContent = selectedA.title + " - Version A";
            document.getElementById('story-a-content').textContent = selectedA.content;
            document.getElementById('story-b-title').textContent = selectedB.title + " - Version B";
            document.getElementById('story-b-content').textContent = selectedB.content;

            // Generic discussion questions
            const questions = [
                "<strong>Bias Detection:</strong> What potential biases can you identify in each vignette?",
                "<strong>Comparison:</strong> How do the scenarios differ in their presentation of the subject?",
                "<strong>Impact Assessment:</strong> Which vignette might lead to more favorable/unfavorable judgments?",
                "<strong>Language Analysis:</strong> What specific words or phrases contribute to potential bias?",
                "<strong>Research Implications:</strong> How might these differences affect research outcomes?"
            ];

            const questionsList = document.getElementById('discussion-questions');
            questionsList.innerHTML = questions.map(q => `<li>${q}</li>`).join('');

            loading.style.display = 'none';
            comparisonSection.style.display = 'block';
            comparisonSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Global variable to store vignette for chat
        let currentVignette = '';
        
        function continueToChat() {
            let vignetteContent = '';
            
            // Check if we have comparison stories or quick story
            const storyAContent = document.getElementById('story-a-content');
            const storyBContent = document.getElementById('story-b-content');
            const quickStoryText = document.getElementById('quick-story-text');
            
            if (storyAContent && storyBContent && storyAContent.textContent && storyBContent.textContent) {
                // Comparison stories
                const titleA = document.getElementById('story-a-title').textContent;
                const titleB = document.getElementById('story-b-title').textContent;
                vignetteContent = `${titleA}: ${storyAContent.textContent}\n\n${titleB}: ${storyBContent.textContent}`;
            } else if (quickStoryText && quickStoryText.textContent) {
                // Quick story
                vignetteContent = quickStoryText.textContent;
            } else {
                alert('Please generate a story first before continuing to chat.');
                return;
            }
            
            // Store vignette for chat
            currentVignette = vignetteContent;
            
            // Log chat transition
            fetch('/api/log-interaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    interaction_type: 'chat_transition',
                    page: 'bias_research_platform',
                    action: 'continue_to_chat',
                    details: 'User continued to chat with generated stories',
                    session_data: 'story_analysis'
                })
            }).catch(console.error);
            
            // Show chat interface
            document.querySelectorAll('.content-panel').forEach(panel => panel.style.display = 'none');
            document.getElementById('chat-interface').classList.add('active');
            document.getElementById('chat-interface').scrollIntoView({ behavior: 'smooth' });
            
            // Add vignette to chat as user message
            const chatMessages = document.getElementById('chat-messages');
            const vignetteMessage = document.createElement('div');
            vignetteMessage.className = 'message user';
            vignetteMessage.innerHTML = `<strong>📖 My Vignette:</strong><br><br>${vignetteContent.replace(/\n/g, '<br>')}`;
            chatMessages.appendChild(vignetteMessage);
            
            // Auto-trigger bias analysis
            setTimeout(() => {
                performBiasAnalysis();
            }, 1000);
        }
        
        async function performBiasAnalysis() {
            const chatMessages = document.getElementById('chat-messages');
            const typingIndicator = document.getElementById('typing-indicator');
            
            // Show typing indicator
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const response = await fetch('/api/student-bias', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vignette: currentVignette
                    })
                });
                
                const data = await response.json();
                
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                if (data.status === 'success') {
                    // Add bias analysis result to chat
                    const biasResult = document.createElement('div');
                    biasResult.className = 'message ai';
                    biasResult.innerHTML = `
                        <strong>🔍 Bias Analysis Results:</strong><br><br>
                        ${data.bias_analysis.replace(/\n/g, '<br>')}
                    `;
                    chatMessages.appendChild(biasResult);
                } else {
                    // Error message
                    const errorResult = document.createElement('div');
                    errorResult.className = 'message ai';
                    errorResult.innerHTML = `
                        <strong>❌ Analysis Error:</strong><br><br>
                        ${data.error || 'Unable to perform bias analysis at this time. Please try again.'}
                    `;
                    chatMessages.appendChild(errorResult);
                }
            } catch (error) {
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                const errorResult = document.createElement('div');
                errorResult.className = 'message ai';
                errorResult.innerHTML = `
                    <strong>❌ Connection Error:</strong><br><br>
                    Unable to connect to the analysis service. Please check your connection and try again.
                `;
                chatMessages.appendChild(errorResult);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            const chatMessages = document.getElementById('chat-messages');
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.textContent = message;
            chatMessages.appendChild(userMessage);
            
            // Clear input and disable send button
            chatInput.value = '';
            sendBtn.disabled = true;
            
            // Show typing indicator
            const typingIndicator = document.getElementById('typing-indicator');
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const response = await fetch('/api/system-chatbots/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatbot_name: 'bias_analyst',
                        message: `Context: ${currentVignette}\n\nUser question: ${message}`
                    })
                });
                
                const data = await response.json();
                
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                if (data.response) {
                    // Add AI response to chat
                    const aiMessage = document.createElement('div');
                    aiMessage.className = 'message ai';
                    aiMessage.innerHTML = data.response.replace(/\n/g, '<br>');
                    chatMessages.appendChild(aiMessage);
                } else {
                    // Error message
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'message ai';
                    errorMessage.innerHTML = 'Sorry, I encountered an error. Please try again.';
                    chatMessages.appendChild(errorMessage);
                }
            } catch (error) {
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message ai';
                errorMessage.innerHTML = 'Connection error. Please check your network and try again.';
                chatMessages.appendChild(errorMessage);
            }
            
            // Re-enable send button
            sendBtn.disabled = false;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function returnToStories() {
            document.getElementById('chat-interface').classList.remove('active');
            document.querySelectorAll('.content-panel')[0].style.display = 'block';
            document.querySelectorAll('.content-panel')[0].scrollIntoView({ behavior: 'smooth' });
        }
        
        // Allow Enter key to send message
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user came from story form submission
            const submittedVignette = sessionStorage.getItem('submittedVignette');
            const fromStoryForm = sessionStorage.getItem('fromStoryForm');
            
            if (submittedVignette && fromStoryForm === 'true') {
                // Clear the session storage flags
                sessionStorage.removeItem('submittedVignette');
                sessionStorage.removeItem('fromStoryForm');
                
                // Set the current vignette
                currentVignette = submittedVignette;
                
                // Automatically show chat interface and start bias discussion
                setTimeout(() => {
                    document.getElementById('chat-interface').classList.add('active');
                    document.getElementById('chat-interface').scrollIntoView({ behavior: 'smooth' });
                    
                    // Add vignette to chat as context
                    const chatMessages = document.getElementById('chat-messages');
                    const vignetteMessage = document.createElement('div');
                    vignetteMessage.className = 'message user';
                    vignetteMessage.innerHTML = `<strong>My submitted story:</strong><br>${submittedVignette}`;
                    chatMessages.appendChild(vignetteMessage);
                    
                    // Send initial bias analysis request
                    setTimeout(() => {
                        performBiasAnalysis();
                    }, 500);
                    
                }, 1000);
            }
            
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });
        
        // Create navigation bar
        createNavigationHeader();
    </script>
</body>
</html>
