<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educational Chatbot Configuration</title>
    <link rel="stylesheet" href="unified-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="navigation.js"></script>
    <style>
        .config-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        
        .config-header {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .config-title {
            color: white;
            font-size: 2.5em;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .config-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1.2em;
            margin: 0;
        }
        
        .config-form {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;

        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .radio-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .radio-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .radio-option input[type="radio"] {
            margin: 0;
        }
        
        .api-key-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .api-key-section.show {
            display: block;
        }
        
        .help-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .radio-option.selected .help-text {
            color: white;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }
        
        .config-button {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            justify-content: center;
        }
        
        .save-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        
        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .load-button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        
        .load-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }
        
        .next-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .next-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .back-button {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }
        
        .hidden-input {
            display: none;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .config-container {
                padding: 20px;
            }
            
            .config-form {
                padding: 25px;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            
            .config-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="config-container">
        <!-- Header -->
        <div class="config-header">
            <h1 class="config-title">ðŸ¤– Educational Chatbot</h1>
            <p class="config-subtitle">Step 1: Configure Your Custom AI Teaching Assistant</p>
        </div>
        
        <!-- Configuration Form -->
        <div class="config-form">
            <form id="chatbot-config-form">
                <!-- Model Selection Section -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-cog"></i>
                        Model Selection
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Choose AI Model:</label>
                        <div class="radio-group">
                            <label class="radio-option" id="standard-option">
                                <input type="radio" name="model-type" value="standard" checked>
                                <div>
                                    <strong>Standard Model</strong>
                                    <div class="help-text">Uses system default (no API key needed)</div>
                                </div>
                            </label>
                            <label class="radio-option" id="custom-option">
                                <input type="radio" name="model-type" value="custom">
                                <div>
                                    <strong>Custom API Key</strong>
                                    <div class="help-text">Use your own OpenAI or Google API key</div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="api-key-section" id="api-key-section">
                            <div class="form-group">
                                <label class="form-label">API Service:</label>
                                <select class="form-input" id="api-service">
                                    <option value="openai">OpenAI (GPT Models)</option>
                                    <option value="google">Google (Gemini Models)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Your API Key:</label>
                                <input type="password" class="form-input" id="api-key" placeholder="Enter your API key">
                                <div class="help-text">
                                    <i class="fas fa-info-circle"></i>
                                    Your API key is only used for this session and is not stored permanently.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System Prompt Configuration -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-user-graduate"></i>
                        Chatbot Personality & Role
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label" for="persona">Persona:</label>
                        <textarea class="form-input form-textarea" id="persona" placeholder="Describe who the chatbot should be (e.g., 'You are an experienced mathematics teacher with 15 years of experience, known for making complex concepts accessible and engaging for students.')"></textarea>
                        <div class="help-text">Define the chatbot's identity, background, and teaching style.</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="core-subject">Core Subject:</label>
                        <textarea class="form-input form-textarea" id="core-subject" placeholder="Specify the main subject area and key topics (e.g., 'High school algebra, focusing on linear equations, quadratic functions, and polynomial operations.')"></textarea>
                        <div class="help-text">What subject(s) and topics should the chatbot specialize in?</div>
                    </div>
                </div>
                
                <!-- Learning Objectives Section -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-target"></i>
                        Learning Goals & Objectives
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label" for="learning-objectives">Learning Objectives:</label>
                        <textarea class="form-input form-textarea" id="learning-objectives" placeholder="List the specific learning goals (e.g., 'Help students understand the relationship between algebraic expressions and real-world problems, develop problem-solving strategies, build confidence in mathematical reasoning.')"></textarea>
                        <div class="help-text">What should students achieve through interactions with this chatbot?</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="constraints">Teaching Constraints & Guidelines:</label>
                        <textarea class="form-input form-textarea" id="constraints" placeholder="Set boundaries and teaching approaches (e.g., 'Always encourage students to show their work, never give direct answers without explanation, adapt language to student's level, ask guiding questions.')"></textarea>
                        <div class="help-text">What rules and approaches should the chatbot follow?</div>
                    </div>
                </div>
                
                <!-- Welcome Message Section -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-comments"></i>
                        Initial Interaction
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label" for="greeting">Welcome Message:</label>
                        <textarea class="form-input form-textarea" id="greeting" placeholder="Write the first message students will see (e.g., 'Hello! I'm your algebra tutor. I'm here to help you understand mathematical concepts step by step. What would you like to work on today?')"></textarea>
                        <div class="help-text">This message will start every conversation with students.</div>
                    </div>
                </div>
            </form>
            
            <!-- Status Messages -->
            <div id="status-message" class="status-message"></div>
            
            <!-- Action Buttons -->
            <div class="button-group">
                <button type="button" class="config-button back-button" onclick="window.location.href='/main-menu'">
                    <i class="fas fa-arrow-left"></i>
                    Back to Menu
                </button>
                
                <button type="button" class="config-button" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24);" onclick="fillTestData()">
                    <i class="fas fa-magic"></i>
                    Fill Test Data
                </button>
                
                <button type="button" class="config-button load-button" onclick="loadConfiguration()">
                    <i class="fas fa-upload"></i>
                    Load Configuration
                </button>
                
                <button type="button" class="config-button save-button" onclick="saveConfiguration()">
                    <i class="fas fa-download"></i>
                    Save Configuration
                </button>
                
                <button type="button" class="config-button next-button" onclick="proceedToChat()">
                    <i class="fas fa-arrow-right"></i>
                    Start Chatbot
                </button>
            </div>
        </div>
        
        <!-- Hidden file input for loading configurations -->
        <input type="file" id="file-input" class="hidden-input" accept=".json" onchange="handleFileLoad(event)">
    </div>

    <script>
        // User session management
        let userId = localStorage.getItem('userId');
        if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userId', userId);
        }

        // Log page load
        fetch('/api/log-interaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: userId,
                interaction_type: 'page_load',
                page: 'chatbot_config',
                action: 'config_page_opened',
                details: 'User opened chatbot configuration page',
                session_data: ''
            })
        }).catch(console.error);

        // Handle model type selection
        document.addEventListener('DOMContentLoaded', function() {
            const radioOptions = document.querySelectorAll('.radio-option');
            const apiKeySection = document.getElementById('api-key-section');
            
            radioOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    radioOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Check the radio button
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Show/hide API key section
                    if (radio.value === 'custom') {
                        apiKeySection.classList.add('show');
                    } else {
                        apiKeySection.classList.remove('show');
                    }
                });
            });
            
            // Set initial state
            document.getElementById('standard-option').classList.add('selected');
        });

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function getFormData() {
            const modelType = document.querySelector('input[name="model-type"]:checked').value;
            
            const config = {
                modelType: modelType,
                apiService: modelType === 'custom' ? document.getElementById('api-service').value : null,
                apiKey: modelType === 'custom' ? document.getElementById('api-key').value : null,
                persona: document.getElementById('persona').value,
                coreSubject: document.getElementById('core-subject').value,
                learningObjectives: document.getElementById('learning-objectives').value,
                constraints: document.getElementById('constraints').value,
                greeting: document.getElementById('greeting').value,
                timestamp: new Date().toISOString()
            };
            
            return config;
        }

        function setFormData(config) {
            // Set model type
            const modelTypeRadio = document.querySelector(`input[name="model-type"][value="${config.modelType}"]`);
            if (modelTypeRadio) {
                modelTypeRadio.checked = true;
                modelTypeRadio.closest('.radio-option').click();
            }
            
            // Set API settings if custom
            if (config.modelType === 'custom') {
                if (config.apiService) document.getElementById('api-service').value = config.apiService;
                if (config.apiKey) document.getElementById('api-key').value = config.apiKey;
            }
            
            // Set form fields
            if (config.persona) document.getElementById('persona').value = config.persona;
            if (config.coreSubject) document.getElementById('core-subject').value = config.coreSubject;
            if (config.learningObjectives) document.getElementById('learning-objectives').value = config.learningObjectives;
            if (config.constraints) document.getElementById('constraints').value = config.constraints;
            if (config.greeting) document.getElementById('greeting').value = config.greeting;
        }

        function saveConfiguration() {
            try {
                const config = getFormData();
                
                // Validate required fields
                if (!config.persona.trim()) {
                    showStatus('Please fill in the Persona field.', 'error');
                    return;
                }
                
                if (!config.coreSubject.trim()) {
                    showStatus('Please fill in the Core Subject field.', 'error');
                    return;
                }
                
                if (!config.greeting.trim()) {
                    showStatus('Please fill in the Welcome Message field.', 'error');
                    return;
                }
                
                // Create filename with timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `chatbot-config-${timestamp}.json`;
                
                // Create and download file
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('Configuration saved successfully!', 'success');
                
                // Log the save action
                fetch('/api/log-interaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        interaction_type: 'config_save',
                        page: 'chatbot_config',
                        action: 'save_configuration',
                        details: 'User saved chatbot configuration',
                        session_data: JSON.stringify({ filename: filename, modelType: config.modelType })
                    })
                }).catch(console.error);
                
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Error saving configuration. Please try again.', 'error');
            }
        }

        function loadConfiguration() {
            document.getElementById('file-input').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/json') {
                showStatus('Please select a valid JSON configuration file.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    setFormData(config);
                    showStatus('Configuration loaded successfully!', 'success');
                    
                    // Log the load action
                    fetch('/api/log-interaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            interaction_type: 'config_load',
                            page: 'chatbot_config',
                            action: 'load_configuration',
                            details: 'User loaded chatbot configuration',
                            session_data: JSON.stringify({ filename: file.name, modelType: config.modelType })
                        })
                    }).catch(console.error);
                    
                } catch (error) {
                    console.error('Load error:', error);
                    showStatus('Error loading configuration file. Please check the file format.', 'error');
                }
            };
            reader.readAsText(file);
            
            // Clear the input so the same file can be loaded again
            event.target.value = '';
        }

        function fillTestData() {
            // Fill with exemplary mathematics tutor configuration
            const testConfig = {
                modelType: 'standard',
                apiService: null,
                apiKey: null,
                persona: 'You are Professor Sarah Chen, an experienced mathematics educator with 12 years of teaching experience at both high school and university levels. You are known for your patient, encouraging approach and ability to break down complex mathematical concepts into digestible steps. You have a PhD in Mathematics Education and specialize in helping students overcome math anxiety while building strong foundational skills.',
                coreSubject: 'High School Algebra and Pre-Calculus, focusing on linear equations, quadratic functions, polynomial operations, exponential and logarithmic functions, and trigonometric basics. Special emphasis on real-world applications and problem-solving strategies.',
                learningObjectives: 'Help students develop strong algebraic thinking skills, understand the relationship between mathematical expressions and real-world problems, build confidence in mathematical reasoning, master step-by-step problem-solving approaches, and prepare for advanced mathematics courses. Foster a growth mindset toward mathematics learning.',
                constraints: 'Always encourage students to show their work and explain their reasoning. Never give direct answers without guiding the student through the solution process. Adapt language and examples to the student\'s level. Ask probing questions to check understanding. Provide positive reinforcement and celebrate progress. Use real-world examples to make concepts relevant and engaging.',
                greeting: 'Hello! I\'m Professor Chen, your personal algebra tutor. I\'m here to help you master mathematical concepts step by step, at your own pace. Whether you\'re working on solving equations, graphing functions, or tackling word problems, we\'ll work through them together. What mathematical topic would you like to explore today?'
            };
            
            setFormData(testConfig);
            showStatus('Test data filled successfully! This is an exemplary mathematics tutor configuration.', 'success');
            
            // Log the test data fill action
            fetch('/api/log-interaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    interaction_type: 'test_data_fill',
                    page: 'chatbot_config',
                    action: 'fill_test_data',
                    details: 'User filled form with test data for mathematics tutor',
                    session_data: 'subject: mathematics, persona: Professor Sarah Chen'
                })
            }).catch(console.error);
        }

        function proceedToChat() {
            try {
                const config = getFormData();
                
                // Validate required fields
                if (!config.persona.trim()) {
                    showStatus('Please fill in the Persona field before proceeding.', 'error');
                    return;
                }
                
                if (!config.coreSubject.trim()) {
                    showStatus('Please fill in the Core Subject field before proceeding.', 'error');
                    return;
                }
                
                if (!config.greeting.trim()) {
                    showStatus('Please fill in the Welcome Message field before proceeding.', 'error');
                    return;
                }
                
                // Validate API key if custom model is selected
                if (config.modelType === 'custom' && !config.apiKey.trim()) {
                    showStatus('Please enter your API key for the custom model.', 'error');
                    return;
                }
                
                // Store configuration in sessionStorage for the chat page
                sessionStorage.setItem('chatbotConfig', JSON.stringify(config));
                
                // Log the proceed action
                fetch('/api/log-interaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        interaction_type: 'config_complete',
                        page: 'chatbot_config',
                        action: 'proceed_to_chat',
                        details: 'User completed configuration and proceeded to chat',
                        session_data: JSON.stringify({ modelType: config.modelType })
                    })
                }).catch(console.error);
                
                // Navigate to chat page
                window.location.href = '/chatbot-interface';
                
            } catch (error) {
                console.error('Proceed error:', error);
                showStatus('Error processing configuration. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>
