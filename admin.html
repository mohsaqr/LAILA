<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - LAILA</title>
    <link rel="stylesheet" href="unified-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="navigation.js"></script>
    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .admin-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .admin-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-section h3 i {
            color: #3498db;
            font-size: 1.2em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .export-form {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        
        .export-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .success-message, .error-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .file-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="content-card">
            <h1 class="page-title">üõ†Ô∏è Admin Panel</h1>
            <p class="page-subtitle">System management and database administration</p>
            
            <div class="admin-grid">
                <!-- Database Statistics Section -->
                <div class="admin-section">
                    <h3><i class="fas fa-database"></i> Database Statistics</h3>
                    <div class="stats-grid" id="stats-container">
                        <div class="stat-item">
                            <span class="stat-value" id="total-messages">-</span>
                            <div class="stat-label">Total Messages</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="total-users">-</span>
                            <div class="stat-label">Active Users</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="recent-activity">-</span>
                            <div class="stat-label">Recent (7 days)</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="avg-response">-</span>
                            <div class="stat-label">Avg Response (sec)</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="loadDatabaseStats()">
                        <i class="fas fa-sync"></i> Refresh Stats
                    </button>
                </div>

                <!-- Export Chat Logs Section -->
                <div class="admin-section">
                    <h3><i class="fas fa-download"></i> Export Chat Logs</h3>
                    <div class="export-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="export-date-from">From Date:</label>
                                <input type="date" id="export-date-from" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="export-date-to">To Date:</label>
                                <input type="date" id="export-date-to" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="export-module">Module:</label>
                                <select id="export-module" class="form-control">
                                    <option value="">All Modules</option>
                                    <option value="Data Interpreter">Data Interpreter</option>
                                    <option value="Prompt Engineering">Prompt Engineering</option>
                                    <option value="Custom Chatbot">Custom Chatbot</option>
                                    <option value="Bias Analysis">Bias Analysis</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="export-user">User:</label>
                                <input type="text" id="export-user" placeholder="user@email.com" class="form-control">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="exportChatLogs()">
                            <i class="fas fa-file-export"></i> Export to CSV
                        </button>
                    </div>
                    <div id="export-success" class="success-message"></div>
                    <div id="export-error" class="error-message"></div>
                </div>

                <!-- System Data Export -->
                <div class="admin-section">
                    <h3><i class="fas fa-file-csv"></i> System Data Export</h3>
                    <p>Export various system data with optional filtering:</p>
                    
                    <!-- Users Export -->
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="exportUsersData()">
                            <i class="fas fa-users"></i> Export Users Data
                        </button>
                    </div>
                    
                    <!-- User Interactions Export -->
                    <div class="export-form">
                        <h4>User Interactions Export</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="interactions-date-from">From Date:</label>
                                <input type="date" id="interactions-date-from" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="interactions-date-to">To Date:</label>
                                <input type="date" id="interactions-date-to" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="interactions-user">User:</label>
                            <input type="text" id="interactions-user" placeholder="user@email.com" class="form-control">
                        </div>
                        <button class="btn btn-success" onclick="exportUserInteractions()">
                            <i class="fas fa-download"></i> Export User Interactions
                        </button>
                    </div>
                    
                    <!-- User Submissions Export -->
                    <div class="export-form">
                        <h4>User Submissions Export</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="submissions-date-from">From Date:</label>
                                <input type="date" id="submissions-date-from" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="submissions-date-to">To Date:</label>
                                <input type="date" id="submissions-date-to" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="submissions-user">User:</label>
                            <input type="text" id="submissions-user" placeholder="user@email.com" class="form-control">
                        </div>
                        <button class="btn btn-success" onclick="exportUserSubmissions()">
                            <i class="fas fa-download"></i> Export User Submissions
                        </button>
                    </div>
                    
                    <div id="system-export-success" class="success-message"></div>
                    <div id="system-export-error" class="error-message"></div>
                </div>

                <!-- Bias Analysis Section -->
                <div class="admin-section">
                    <h3><i class="fas fa-balance-scale"></i> Bias Analysis</h3>
                    <div class="form-group">
                        <label for="ai-service">AI Service:</label>
                        <select id="ai-service" class="form-control">
                            <option value="google">Google AI (System Key)</option>
                            <option value="openai">OpenAI (System Key)</option>
                            <option value="test">Test Mode</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vignette-input">Vignette to Analyze:</label>
                        <textarea id="vignette-input" rows="4" placeholder="Enter or paste a vignette..." class="form-control"></textarea>
                    </div>
                    <button class="btn btn-warning" onclick="analyzeBias()">
                        <i class="fas fa-search"></i> Analyze for Bias
                    </button>
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="bias-result">Analysis Result:</label>
                        <textarea id="bias-result" rows="6" readonly placeholder="Analysis will appear here..." class="form-control"></textarea>
                    </div>
                </div>

                <!-- Custom Chatbots Section -->
                <div class="admin-section">
                    <h3><i class="fas fa-robot"></i> Custom Chatbots</h3>
                    <p>Create and manage AI chatbots for all users.</p>
                    <div class="form-group">
                        <a href="chatbot-admin.html" class="btn btn-primary">
                            <i class="fas fa-cog"></i> Manage Chatbots
                        </a>
                        <a href="custom-chatbots.html" class="btn btn-info">
                            <i class="fas fa-comments"></i> Test Chatbots
                        </a>
                    </div>
                </div>

                <!-- System Logs Section -->
                <div class="admin-section">
                    <h3><i class="fas fa-list"></i> System Logs</h3>
                    <p>View comprehensive system logs and user interactions.</p>
                    <div class="form-group">
                        <a href="logs.html" class="btn btn-info">
                            <i class="fas fa-eye"></i> View Detailed Logs
                        </a>
                        <a href="analytics.html" class="btn btn-info">
                            <i class="fas fa-chart-bar"></i> View Analytics
                        </a>
                    </div>
                </div>

                <!-- System AI Settings Section -->
                <div class="admin-section">
                    <h3><i class="fas fa-cog"></i> AI Configuration</h3>
                    <div class="form-group">
                        <label for="system-ai-service">Default AI Service:</label>
                        <select id="system-ai-service" class="form-control">
                            <option value="google">Google (Gemini Models)</option>
                            <option value="openai">OpenAI (GPT Models)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="system-ai-model">Default AI Model:</label>
                        <select id="system-ai-model" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label for="system-google-key">Google API Key:</label>
                        <input type="password" id="system-google-key" placeholder="AIza..." class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="system-openai-key">OpenAI API Key:</label>
                        <input type="password" id="system-openai-key" placeholder="sk-..." class="form-control">
                    </div>
                    <button class="btn btn-primary" onclick="saveSystemSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                    <div id="settings-status" class="success-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // System Models Configuration
        const systemModels = {
            'google': [
                { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash (Fast)' },
                { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro (Advanced)' },
                { id: 'gemini-pro', name: 'Gemini Pro (Standard)' }
            ],
            'openai': [
                { id: 'gpt-4o-mini', name: 'GPT-4o Mini (Fast & Efficient)' },
                { id: 'gpt-4o', name: 'GPT-4o (Advanced)' },
                { id: 'gpt-4-turbo', name: 'GPT-4 Turbo (Balanced)' },
                { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo (Basic)' }
            ]
        };

        // Load Database Statistics
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/admin/database-stats');
                if (!response.ok) throw new Error('Failed to load stats');
                
                const data = await response.json();
                const stats = data.stats;
                
                document.getElementById('total-messages').textContent = stats.total_messages.toLocaleString();
                document.getElementById('total-users').textContent = Object.keys(stats.top_users).length;
                document.getElementById('recent-activity').textContent = stats.recent_messages.toLocaleString();
                document.getElementById('avg-response').textContent = stats.avg_response_time || '0';
                
            } catch (error) {
                console.error('Error loading database stats:', error);
                showMessage('Failed to load database statistics', 'error');
            }
        }

        // Export Chat Logs
        async function exportChatLogs() {
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;
            const module = document.getElementById('export-module').value;
            const user = document.getElementById('export-user').value;
            
            try {
                const response = await fetch('/api/admin/export-chat-logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date_from: dateFrom || null,
                        date_to: dateTo || null,
                        module: module || null,
                        user: user || null
                    })
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                const data = await response.json();
                showMessage(`‚úÖ ${data.message}`, 'success', 'export');
                
                // Auto-download the file
                setTimeout(() => {
                    window.location.href = `/api/admin/download-export/${data.filename}`;
                }, 1000);
                
            } catch (error) {
                console.error('Error exporting chat logs:', error);
                showMessage('‚ùå Failed to export chat logs', 'error', 'export');
            }
        }

        // Export Users Data
        async function exportUsersData() {
            try {
                const response = await fetch('/api/admin/export-users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                const data = await response.json();
                showMessage(`‚úÖ ${data.message}`, 'success', 'system-export');
                
                // Auto-download the file
                setTimeout(() => {
                    window.location.href = `/api/admin/download-export/${data.filename}`;
                }, 1000);
                
            } catch (error) {
                console.error('Error exporting users data:', error);
                showMessage('‚ùå Failed to export users data', 'error', 'system-export');
            }
        }

        // Export User Interactions
        async function exportUserInteractions() {
            const dateFrom = document.getElementById('interactions-date-from').value;
            const dateTo = document.getElementById('interactions-date-to').value;
            const user = document.getElementById('interactions-user').value;
            
            try {
                const response = await fetch('/api/admin/export-interactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date_from: dateFrom || null,
                        date_to: dateTo || null,
                        user: user || null
                    })
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                const data = await response.json();
                showMessage(`‚úÖ ${data.message}`, 'success', 'system-export');
                
                // Auto-download the file
                setTimeout(() => {
                    window.location.href = `/api/admin/download-export/${data.filename}`;
                }, 1000);
                
            } catch (error) {
                console.error('Error exporting user interactions:', error);
                showMessage('‚ùå Failed to export user interactions', 'error', 'system-export');
            }
        }

        // Export User Submissions
        async function exportUserSubmissions() {
            const dateFrom = document.getElementById('submissions-date-from').value;
            const dateTo = document.getElementById('submissions-date-to').value;
            const user = document.getElementById('submissions-user').value;
            
            try {
                const response = await fetch('/api/admin/export-submissions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date_from: dateFrom || null,
                        date_to: dateTo || null,
                        user: user || null
                    })
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                const data = await response.json();
                showMessage(`‚úÖ ${data.message}`, 'success', 'system-export');
                
                // Auto-download the file
                setTimeout(() => {
                    window.location.href = `/api/admin/download-export/${data.filename}`;
                }, 1000);
                
            } catch (error) {
                console.error('Error exporting user submissions:', error);
                showMessage('‚ùå Failed to export user submissions', 'error', 'system-export');
            }
        }

        // Analyze Bias
        async function analyzeBias() {
            const vignette = document.getElementById('vignette-input').value;
            const service = document.getElementById('ai-service').value;
            
            if (!vignette.trim()) {
                showMessage('Please enter a vignette to analyze', 'error');
                return;
            }
            
            try {
                document.getElementById('bias-result').value = 'Analyzing...';
                
                const response = await fetch('/api/bias', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vignette, service })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Analysis failed');
                }
                
                const result = await response.json();
                document.getElementById('bias-result').value = `[${(result.service || service).toUpperCase()} ANALYSIS]\n\n${result.bias_analysis}`;
                showMessage('‚úÖ Bias analysis complete', 'success');
                
            } catch (error) {
                document.getElementById('bias-result').value = 'Error: ' + error.message;
                showMessage('‚ùå Bias analysis failed: ' + error.message, 'error');
            }
        }

        // Save System Settings
        async function saveSystemSettings() {
            const service = document.getElementById('system-ai-service').value;
            const model = document.getElementById('system-ai-model').value;
            const googleKey = document.getElementById('system-google-key').value;
            const openaiKey = document.getElementById('system-openai-key').value;
            
            try {
                const response = await fetch('/api/system-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ai_service: service,
                        ai_model: model,
                        google_api_key: googleKey,
                        openai_api_key: openaiKey
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save settings');
                
                showMessage('‚úÖ System settings saved successfully', 'success', 'settings');
                
            } catch (error) {
                console.error('Error saving system settings:', error);
                showMessage('‚ùå Failed to save system settings', 'error', 'settings');
            }
        }

        // Update model dropdown when service changes
        document.getElementById('system-ai-service').addEventListener('change', function() {
            const service = this.value;
            const modelSelect = document.getElementById('system-ai-model');
            modelSelect.innerHTML = '';
            
            systemModels[service].forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                modelSelect.appendChild(option);
            });
        });

        // Show Messages
        function showMessage(message, type, section = '') {
            let targetElement;
            
            if (section === 'export') {
                targetElement = document.getElementById(type === 'success' ? 'export-success' : 'export-error');
            } else if (section === 'system-export') {
                targetElement = document.getElementById(type === 'success' ? 'system-export-success' : 'system-export-error');
            } else if (section === 'settings') {
                targetElement = document.getElementById('settings-status');
            } else {
                // Create a general message
                const messageDiv = document.createElement('div');
                messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
                messageDiv.style.display = 'block';
                messageDiv.textContent = message;
                document.querySelector('.content-card').insertBefore(messageDiv, document.querySelector('.admin-grid'));
                setTimeout(() => messageDiv.remove(), 5000);
                return;
            }
            
            targetElement.textContent = message;
            targetElement.style.display = 'block';
            setTimeout(() => targetElement.style.display = 'none', 5000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            loadDatabaseStats();
            
            // Initialize model dropdown
            document.getElementById('system-ai-service').dispatchEvent(new Event('change'));
            
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            document.getElementById('export-date-to').value = today.toISOString().split('T')[0];
            document.getElementById('export-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
        });
    </script>
</body>
</html>